<!DOCTYPE html>
<html lang="en" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnasFinance | Personal Dashboard</title>
    
    <!-- 
    AnasFinance - Personal Finance Dashboard
    AI Search & Multi-language Support (English/Urdu)
    -->

    <link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 204 131.16"><g fill="none" stroke="%2361fffa" stroke-width="4" stroke-miterlimit="10"><path d="M2,26.5h200" stroke-linecap="round" stroke-linejoin="round"/><path d="M20,129.1l-18-20.8V22.8l18-20.8h164l18,20.8v85.5l-18,20.8z" stroke-linecap="round" stroke-linejoin="round"/><path d="M29,111.8l-12-13.9V50.5l12-13.9h146l12,13.9v47.4l-12,13.9z" stroke-linecap="round" stroke-linejoin="round"/><path d="M84.9,92.4l-6-6V58.4l6-6h83l6,6v28l-6,6z" stroke-linecap="round" stroke-linejoin="round"/><path d="M78.9,65.4h55M78.9,77.4h35" stroke-linecap="round" stroke-linejoin="round"/><path d="M35.7,91.9h30.8l2.6-5.6V60.2l-2.6-5.6H30.1l-2.6,5.6v26.1l2.6,5.6h3.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M36,91.8c-0.1-0.8-0.2-1.6-0.2-2.4c0-7 5.7-12.8 12.8-12.8c7,0 12.8,5.7 12.8,12.8c0,1.3-0.2,2.6-0.6,3.9M54.2,66.3c0,3.1-2.6,5.7-5.7,5.7c-3.1,0-5.7-2.6-5.7-5.7c0-3.1 2.6-5.7 5.7-5.7c3.1,0 5.7,2.6 5.7,5.7z" stroke-linecap="butt"/></g></svg>'>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');
        :root { --custom-accent: #61fffa; }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; min-height: 100vh; }
        
        /* Urdu Support Classes */
        [dir="rtl"] { font-family: 'Noto Nastaliq Urdu', 'Inter', serif; }
        [dir="rtl"] .tracking-widest { tracking: normal; }
        
        [data-theme="emerald"] body { background-color: #f1f5f9; }
        [data-theme="dark"] body { background-color: #000000; }
        
        .glass-card { backdrop-filter: blur(12px); transition: all 0.3s ease; }
        [data-theme="emerald"] .glass-card { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.3); }
        [data-theme="dark"] .glass-card { background: rgba(10, 10, 15, 0.85); border: 1px solid rgba(255, 255, 255, 0.06); }
        
        .custom-logo-svg { width: 56px; height: auto; }
        #auth-overlay { position: fixed; inset: 0; z-index: 5000; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; }
        .auth-hidden { display: none !important; }
        
        .ai-pulse { animation: ai-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes ai-pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .markdown-content p { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <!-- Authentication Overlay -->
    <div id="auth-overlay">
        <div class="card glass-card w-full max-w-md shadow-2xl p-8 text-neutral">
            <div class="text-center mb-6">
                <svg class="custom-logo-svg mx-auto mb-4" viewBox="0 0 204 131.16" xmlns="http://www.w3.org/2000/svg">
                    <g fill="none" stroke="currentColor" stroke-width="4" stroke-miterlimit="10">
                        <path d="M2,26.5h200" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M20,129.1l-18,-20.8V22.8l18,-20.8h164l18,20.8v85.5l-18,20.8z" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M29,111.8l-12,-13.9V50.5l12,-13.9h146l12,13.9v47.4l-12,13.9z" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M84.9,92.4l-6,-6V58.4l6,-6h83l6,6v28l-6,6z" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M78.9,65.4h55" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M78.9,77.4h35" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M35.7,91.9h30.8l2.6-5.6V60.2l-2.6-5.6H30.1l-2.6,5.6v26.1l2.6,5.6h3.2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M36,91.8c-0.1-0.8-0.2-1.6-0.2-2.4c0-7 5.7-12.8 12.8-12.8c7,0 12.8,5.7 12.8,12.8c0,1.3-0.2,2.6-0.6,3.9M54.2,66.3c0,3.1-2.6,5.7-5.7,5.7c-3.1,0-5.7-2.6-5.7-5.7c0-3.1 2.6-5.7 5.7-5.7c3.1,0 5.7,2.6 5.7,5.7z" stroke-linecap="butt"/>
                    </g>
                </svg>
                <h1 class="text-2xl font-black uppercase tracking-tight">AnasFinance</h1>
                <p class="text-xs font-bold opacity-50 uppercase tracking-widest mt-1">Cloud Sync Enabled</p>
            </div>

            <div id="auth-forms" class="space-y-4">
                <div class="space-y-3">
                    <div class="form-control w-full">
                        <label class="label pt-0"><span class="label-text text-[10px] font-black uppercase opacity-50">Identity</span></label>
                        <input type="email" id="auth-email" placeholder="EMAIL ADDRESS" class="input input-bordered w-full input-sm font-bold bg-base-100/20" />
                    </div>
                    
                    <div class="form-control w-full">
                        <label class="label pt-0"><span class="label-text text-[10px] font-black uppercase opacity-50">Security</span></label>
                        <div class="relative w-full">
                            <input type="password" id="auth-pass" placeholder="PASSWORD" class="input input-bordered w-full input-sm font-bold bg-base-100/20 pr-10" />
                            <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 opacity-50 hover:opacity-100 transition-opacity">
                                <i id="eye-icon" data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-2 pt-2">
                    <button onclick="handleEmailAuth('signin')" class="btn btn-primary btn-sm font-black uppercase tracking-widest">Login</button>
                    <button onclick="handleEmailAuth('signup')" class="btn btn-ghost btn-sm font-black uppercase tracking-widest border border-base-300">Create Account</button>
                </div>
            </div>

            <div id="auth-loading" class="hidden flex flex-col items-center py-8">
                <span class="loading loading-ring loading-lg text-primary"></span>
                <p class="text-[10px] font-black uppercase tracking-widest mt-4">Authenticating...</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex items-center gap-3">
                <div class="p-1 rounded-xl transition-colors duration-300">
                    <svg class="custom-logo-svg" viewBox="0 0 204 131.16" xmlns="http://www.w3.org/2000/svg">
                        <g fill="none" stroke="currentColor" stroke-width="4" stroke-miterlimit="10">
                            <path d="M2,26.5h200" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20,129.1l-18,-20.8V22.8l18,-20.8h164l18,20.8v85.5l-18,20.8z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M29,111.8l-12,-13.9V50.5l12,-13.9h146l12,13.9v47.4l-12,13.9z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M84.9,92.4l-6,-6V58.4l6,-6h83l6,6v28l-6,6z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M78.9,65.4h55" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M78.9,77.4h35" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M35.7,91.9h30.8l2.6-5.6V60.2l-2.6-5.6H30.1l-2.6,5.6v26.1l2.6,5.6h3.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M36,91.8c-0.1-0.8-0.2-1.6-0.2-2.4c0-7 5.7-12.8 12.8-12.8c7,0 12.8,5.7 12.8,12.8c0,1.3-0.2,2.6-0.6,3.9M54.2,66.3c0,3.1-2.6,5.7-5.7,5.7c-3.1,0-5.7-2.6-5.7-5.7c0-3.1 2.6-5.7 5.7-5.7c3.1,0 5.7,2.6 5.7,5.7z" stroke-linecap="butt"/>
                        </g>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tight uppercase">AnasFinance</h1>
                    <div class="flex items-center gap-2">
                        <p id="user-display" class="text-[10px] font-bold opacity-50 tracking-[0.2em]">OFFLINE</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2 items-center">
                <a href="https://buymeacoffee.com/anashazz" target="_blank" class="btn btn-ghost btn-sm font-black uppercase tracking-widest text-[10px] bg-yellow-400/10 hover:bg-yellow-400/20 border border-yellow-400/30 text-yellow-600 dark:text-yellow-400">
                    <i data-lucide="coffee" class="w-3.5 h-3.5 mr-1"></i> <span data-t="coffee">Buy Me A Coffee</span>
                </a>

                <!-- Settings Dropdown -->
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-sm font-black uppercase tracking-widest text-[10px] bg-base-100/50 border border-base-300">
                        <i data-lucide="settings" class="w-3.5 h-3.5 mr-1"></i> <span data-t="settings">Settings</span>
                    </div>
                    <ul tabindex="0" class="dropdown-content z-[100] menu p-2 shadow-2xl glass-card rounded-xl w-52 mt-2">
                        <li><h2 class="menu-title text-[10px] font-black uppercase tracking-widest opacity-50">Language / زبان</h2></li>
                        <li>
                            <button onclick="setLanguage('en')" class="flex justify-between items-center py-2">
                                <span class="font-bold text-xs">English</span>
                                <i id="lang-check-en" data-lucide="check" class="w-3 h-3 text-primary"></i>
                            </button>
                        </li>
                        <li>
                            <button onclick="setLanguage('ur')" class="flex justify-between items-center py-2">
                                <span class="font-bold text-xs">Urdu (اردو)</span>
                                <i id="lang-check-ur" data-lucide="check" class="w-3 h-3 text-primary hidden"></i>
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-lg blur opacity-25 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"></div>
                    <button onclick="toggleAISearch()" class="relative btn btn-ghost btn-sm font-black uppercase tracking-widest text-[10px] bg-base-100/50 border border-base-300">
                        <i data-lucide="sparkles" class="w-3.5 h-3.5 text-cyan-400"></i> <span data-t="aiSearch">AI Search</span>
                    </button>
                </div>

                <button id="theme-toggle" onclick="toggleTheme()" class="btn btn-ghost btn-circle btn-sm" title="Toggle Dark Mode">
                    <i data-lucide="moon" id="theme-icon-dark" class="w-4 h-4"></i>
                    <i data-lucide="sun" id="theme-icon-light" class="w-4 h-4 hidden"></i>
                </button>
                <div class="h-6 w-[1px] bg-base-300 opacity-50"></div>
                <button onclick="handleSignOut()" class="btn btn-ghost btn-xs gap-2 font-bold uppercase tracking-widest bg-base-100/50 border border-base-300 text-error">
                    <i data-lucide="log-out" class="w-3 h-3"></i> <span data-t="exit">Exit</span>
                </button>
            </div>
        </header>

        <!-- AI Search Container -->
        <div id="ai-search-container" class="hidden mb-6 animate-in slide-in-from-top duration-300">
            <div class="card glass-card shadow-xl border-2 border-primary/20">
                <div class="card-body p-4">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center">
                            <i data-lucide="bot" class="w-5 h-5 text-primary"></i>
                        </div>
                        <h3 class="text-xs font-black uppercase tracking-widest" data-t="aiTitle">Gemini Financial Assistant</h3>
                        <button onclick="toggleAISearch()" class="btn btn-ghost btn-xs btn-circle ml-auto">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="join w-full shadow-sm">
                        <input id="ai-query" type="text" data-t-ph="aiPlaceholder" placeholder="Ask anything about your spending..." class="input input-bordered join-item w-full font-bold text-sm bg-base-100/50" onkeyup="if(event.key==='Enter') runAISearch()" />
                        <button onclick="runAISearch()" class="btn btn-primary join-item font-black uppercase tracking-widest" data-t="ask">Ask</button>
                    </div>

                    <div id="ai-response-box" class="hidden mt-4 p-4 rounded-xl bg-base-100/30 border border-base-300 min-h-[60px] relative">
                        <div id="ai-loading" class="hidden flex items-center gap-3">
                            <span class="loading loading-dots loading-sm text-primary"></span>
                            <span class="text-[10px] font-black uppercase tracking-widest opacity-50 ai-pulse" data-t="aiAnalyzing">Analyzing Transaction Data...</span>
                        </div>
                        <div id="ai-content" class="text-sm font-medium leading-relaxed markdown-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="stats shadow-sm glass-card border-none">
                <div class="stat p-4">
                    <div class="stat-title text-[10px] font-black uppercase tracking-widest opacity-60" data-t="totalSpent">Total Spent</div>
                    <div id="total-amount" class="stat-value text-xl font-black text-primary">$0.00</div>
                </div>
            </div>
            <div class="stats shadow-sm glass-card border-none">
                <div class="stat p-4">
                    <div class="stat-title text-[10px] font-black uppercase tracking-widest opacity-60" data-t="categories">Categories</div>
                    <div id="category-count" class="stat-value text-xl font-black text-secondary">0</div>
                </div>
            </div>
            <div class="stats shadow-sm glass-card border-none">
                <div class="stat p-4">
                    <div class="stat-title text-[10px] font-black uppercase tracking-widest opacity-60" data-t="syncHistory">Sync History</div>
                    <div id="transaction-count" class="stat-value text-xl font-black text-accent">0</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 flex flex-col gap-6">
                <div class="card glass-card shadow-lg">
                    <div class="card-body p-5">
                        <h2 class="text-sm font-black uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4 text-primary"></i> <span data-t="quickAdd">Quick Add</span>
                        </h2>
                        <form id="expense-form" class="space-y-3">
                            <input type="text" id="desc" data-t-ph="descPh" placeholder="Description" class="input input-bordered bg-base-100/40 input-sm w-full font-medium" required />
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="amount" step="0.01" data-t-ph="amountPh" placeholder="$0.00" class="input input-bordered bg-base-100/40 input-sm w-full font-medium" required />
                                <select id="category" class="select select-bordered bg-base-100/40 select-sm w-full font-medium">
                                    <option value="Food">Food</option><option value="Utilities">Utilities</option><option value="Transport">Transport</option>
                                    <option value="Fun">Fun</option><option value="Health">Health</option><option value="Shopping">Shopping</option><option value="Other">Other</option>
                                </select>
                            </div>
                            <input type="date" id="date" class="input input-bordered bg-base-100/40 input-sm w-full font-medium" required />
                            <button type="submit" id="save-btn" class="btn btn-primary btn-sm w-full rounded-lg font-black uppercase tracking-widest" data-t="save">Save</button>
                        </form>
                    </div>
                </div>

                <div class="card glass-card shadow-lg flex-1 overflow-hidden min-h-[250px]">
                    <div class="card-body p-0">
                        <div class="p-5 pb-2">
                            <h2 class="text-sm font-black uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4 text-secondary"></i> <span data-t="recent">Recent</span>
                            </h2>
                        </div>
                        <div id="history-list" class="max-h-[350px] overflow-y-auto px-5 pb-5 space-y-2"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="card glass-card shadow-lg h-full min-h-[400px]">
                    <div class="card-body p-5">
                        <h2 class="text-sm font-black uppercase tracking-widest mb-6 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-4 h-4 text-accent"></i> <span data-t="analysis">Analysis</span>
                        </h2>
                        <div class="flex-1 relative flex items-center justify-center">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-12 mb-6 text-center">
            <div class="divider opacity-20"></div>
            <p class="text-[10px] font-black uppercase tracking-[0.3em] opacity-40">AnasFinance v1.0.7</p>
        </footer>
    </div>

    <div id="toast-container" class="toast toast-end toast-bottom z-[6000]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            deleteDoc, 
            collection, 
            onSnapshot, 
            addDoc 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVCytho4Ea_il-81cG7bs0fRcBoy70Sv4",
            authDomain: "anasfinance-f66ce.firebaseapp.com",
            projectId: "anasfinance-f66ce",
            storageBucket: "anasfinance-f66ce.firebasestorage.app",
            messagingSenderId: "400787888202",
            appId: "1:400787888202:web:4b63f5924d1ce62af56eb3"
        };

        const appId = 'anas-finance-app';
        let transactions = [];
        let myChart = null;
        let db, auth, currentUser;
        
        const apiKey = "AIzaSyDs0OEweDFq2Z3gXdC5IRS-IfibESJfesY";

        // Internationalization Data
        const translations = {
            en: {
                coffee: "Buy Me A Coffee", settings: "Settings", aiSearch: "AI Search", exit: "Exit",
                totalSpent: "Total Spent", categories: "Categories", syncHistory: "Sync History",
                quickAdd: "Quick Add", save: "Save", recent: "Recent", analysis: "Analysis",
                aiTitle: "Gemini Financial Assistant", aiPlaceholder: "Ask anything about your spending...",
                ask: "Ask", aiAnalyzing: "Analyzing Transaction Data...", 
                descPh: "Description", amountPh: "$0.00", empty: "Workspace Empty",
                recordDeleted: "Record Deleted", synced: "Synced Success", saveFailed: "Save failed"
            },
            ur: {
                coffee: "مجھے ایک کافی خریدیں۔", settings: "ترتیبات", aiSearch: "AI تلاش", exit: "باہر نکلیں",
                totalSpent: "کل خرچ", categories: "اقسام", syncHistory: "تاریخ",
                quickAdd: "فوری اندراج", save: "محفوظ کریں", recent: "حالیہ", analysis: "تجزیہ",
                aiTitle: "جیمنائی مالیاتی معاون", aiPlaceholder: "اپنے اخراجات کے بارے میں پوچھیں...",
                ask: "پوچھیں", aiAnalyzing: "ڈیٹا کا تجزیہ کیا جا رہا ہے...",
                descPh: "تفصیل", amountPh: "رقم", empty: "کوئی ریکارڈ نہیں",
                recordDeleted: "ریکارڈ حذف ہو گیا", synced: "کامیابی سے محفوظ", saveFailed: "محفوظ کرنے میں ناکامی"
            }
        };

        const authOverlay = document.getElementById('auth-overlay');
        const authLoading = document.getElementById('auth-loading');
        const authForms = document.getElementById('auth-forms');
        const userDisplay = document.getElementById('user-display');
        const historyList = document.getElementById('history-list');
        const totalAmountEl = document.getElementById('total-amount');
        const categoryCountEl = document.getElementById('category-count');
        const transactionCountEl = document.getElementById('transaction-count');
        const expenseForm = document.getElementById('expense-form');

        lucide.createIcons();
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authOverlay.classList.add('auth-hidden');
                userDisplay.innerText = user.email || user.uid.substring(0, 8);
                setupRealtimeSync(user.uid);
            } else {
                currentUser = null;
                authOverlay.classList.remove('auth-hidden');
                authLoading.classList.add('hidden');
                authForms.classList.remove('hidden');
                userDisplay.innerText = "OFFLINE";
                transactions = [];
                updateUI();
            }
        });

        window.handleEmailAuth = async (type) => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if (!email || !pass) return showToast("Credentials required", "info");
            setAuthLoading(true);
            try {
                if (type === 'signup') await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showToast(error.message, "error");
                setAuthLoading(false);
            }
        };

        window.togglePasswordVisibility = () => {
            const passInput = document.getElementById('auth-pass');
            const eyeIcon = document.getElementById('eye-icon');
            passInput.type = passInput.type === 'password' ? 'text' : 'password';
            eyeIcon.setAttribute('data-lucide', passInput.type === 'password' ? 'eye' : 'eye-off');
            lucide.createIcons();
        };

        window.handleSignOut = () => signOut(auth);

        function setAuthLoading(isLoading) {
            authForms.classList.toggle('hidden', isLoading);
            authLoading.classList.toggle('hidden', !isLoading);
        }

        function setupRealtimeSync(userId) {
            const ref = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            onSnapshot(ref, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
        }

        window.onload = () => {
            applyTheme();
            const lang = localStorage.getItem('lang') || 'en';
            setLanguage(lang);
            initChart();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        };

        // Language Management
        window.setLanguage = (lang) => {
            localStorage.setItem('lang', lang);
            document.body.dir = lang === 'ur' ? 'rtl' : 'ltr';
            
            // Update Text
            const t = translations[lang];
            document.querySelectorAll('[data-t]').forEach(el => {
                const key = el.getAttribute('data-t');
                if (t[key]) el.innerText = t[key];
            });

            // Update Placeholders
            document.querySelectorAll('[data-t-ph]').forEach(el => {
                const key = el.getAttribute('data-t-ph');
                if (t[key]) el.placeholder = t[key];
            });

            // Update Active Checkmark UI
            document.getElementById('lang-check-en').classList.toggle('hidden', lang !== 'en');
            document.getElementById('lang-check-ur').classList.toggle('hidden', lang !== 'ur');

            updateUI(); // Refresh dynamic content
            if (myChart) myChart.update();
        };

        function applyTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'emerald');
            document.getElementById('theme-icon-dark').classList.toggle('hidden', isDark);
            document.getElementById('theme-icon-light').classList.toggle('hidden', !isDark);
            if (myChart) updateChartColors();
        }

        window.toggleTheme = () => {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'dark';
            localStorage.setItem('theme', isDark ? 'dark' : 'emerald');
            applyTheme();
        };

        function updateChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (myChart) {
                myChart.options.plugins.legend.labels.color = isDark ? '#94a3b8' : '#475569';
                myChart.update();
            }
        }

        function initChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#61fffa', '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                padding: 20, 
                                font: { size: 9, weight: 'bold' }, 
                                usePointStyle: true 
                            } 
                        }
                    },
                    cutout: '80%'
                }
            });
        }

        function updateUI() {
            if (!historyList) return;
            historyList.innerHTML = '';
            const lang = localStorage.getItem('lang') || 'en';
            const t = translations[lang];
            
            if (!transactions || transactions.length === 0) {
                historyList.innerHTML = `<p class="text-[9px] opacity-30 text-center py-10 font-bold uppercase tracking-widest">${t.empty}</p>`;
                totalAmountEl.innerText = "$0.00";
                categoryCountEl.innerText = "0";
                transactionCountEl.innerText = "0";
                if (myChart) { myChart.data.labels = []; myChart.data.datasets[0].data = []; myChart.update(); }
                return;
            }

            [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((tx) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 px-3 rounded-lg bg-base-100/40 border border-base-300/50 hover:bg-base-200/80 transition-all group';
                item.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-[11px] text-neutral leading-tight">${tx.description}</span>
                        <span class="text-[8px] opacity-40 uppercase font-black tracking-tighter">${tx.category} • ${tx.date}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-black text-xs text-error">-$${parseFloat(tx.amount).toFixed(2)}</span>
                        <button class="delete-btn btn btn-ghost btn-xs p-0 h-5 w-5 opacity-0 group-hover:opacity-100" data-id="${tx.id}"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                `;
                historyList.appendChild(item);
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm("Remove?")) return;
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', btn.dataset.id));
                    showToast(t.recordDeleted, "info");
                };
            });

            lucide.createIcons();
            const total = transactions.reduce((acc, curr) => acc + parseFloat(curr.amount || 0), 0);
            totalAmountEl.innerText = `$${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            categoryCountEl.innerText = new Set(transactions.map(t => t.category)).size;
            transactionCountEl.innerText = transactions.length;
            
            const totals = {};
            transactions.forEach(tx => { totals[tx.category] = (totals[tx.category] || 0) + parseFloat(tx.amount); });
            if (myChart) { 
                myChart.data.labels = Object.keys(totals); 
                myChart.data.datasets[0].data = Object.values(totals); 
                myChart.update(); 
            }
        }

        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const lang = localStorage.getItem('lang') || 'en';
            const t = translations[lang];
            const newTx = {
                description: document.getElementById('desc').value,
                amount: document.getElementById('amount').value,
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                createdAt: Date.now()
            };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), newTx);
                expenseForm.reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                showToast(t.synced);
            } catch (err) { showToast(t.saveFailed, "error"); }
        });

        window.toggleAISearch = () => {
            const container = document.getElementById('ai-search-container');
            container.classList.toggle('hidden');
            if(!container.classList.contains('hidden')) document.getElementById('ai-query').focus();
        };

        window.runAISearch = async () => {
            const queryInput = document.getElementById('ai-query');
            const query = queryInput.value.trim();
            if (!query) return;
            const responseBox = document.getElementById('ai-response-box');
            const loading = document.getElementById('ai-loading');
            const content = document.getElementById('ai-content');
            responseBox.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.innerText = '';
            queryInput.value = '';
            try {
                const response = await callGemini(query);
                content.innerHTML = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } catch (err) { content.innerText = "Error analyzing data."; } 
            finally { loading.classList.add('hidden'); }
        };

        async function callGemini(userQuery) {
            const dataContext = transactions.map(t => `${t.date}: ${t.description} - $${t.amount} (${t.category})`).join('\n');
            const systemPrompt = `You are a financial AI. Respond in the user's preferred language (English or Urdu). Data:\n${dataContext}`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                } catch (err) {
                    if (i === 4) throw err;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        function showToast(m, type = "success") {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `alert alert-${type} text-white shadow-lg p-2 px-4 rounded-lg text-[10px] font-black uppercase tracking-widest animate-bounce`;
            t.innerHTML = `<span>${m}</span>`;
            c.appendChild(t);
            setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.remove(), 500); }, 3000);
        }
    </script>
</body>
</html>
